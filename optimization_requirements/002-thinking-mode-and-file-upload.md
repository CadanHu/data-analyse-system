# 思考模式开关与文件上传功能

**需求编号**: 002  
**创建日期**: 2026-02-22  
**状态**: 待开发

---

## 任务目标

1. 添加思考模式切换开关（默认关闭）
2. 添加文件上传功能（支持照片和文件）
3. 集成两个开源测试数据库

---

## 功能需求

### 1. 思考模式切换开关

**需求描述**：
- 在输入框附近添加一个切换开关，类似 OpenAI 官网的设计
- 默认状态：**关闭**（非思考模式）
- 用户可以手动开启思考模式

**UI 设计**：
- 位置：输入框右上角或工具栏
- 图标：灯泡或大脑图标
- 状态：开/关切换
- 提示：鼠标悬停显示"思考模式"说明

**交互逻辑**：
- 关闭状态：使用普通模式（不显示推理过程）
- 开启状态：使用思考模式（显示推理过程）
- 状态持久化：保存到 localStorage

---

### 2. 文件上传功能

**需求描述**：
- 在输入框左侧添加"+"按钮
- 点击后弹出文件选择器
- 支持上传照片和文件

**UI 设计**：
- 位置：输入框左侧
- 图标："+"号
- 点击效果：弹出文件选择对话框

**支持格式**：
- 图片：JPG, PNG, GIF, WebP
- 文档：PDF, TXT, CSV, Excel
- 最大大小：10MB

**上传流程**：
1. 用户点击"+"按钮
2. 选择文件
3. 显示上传进度
4. 上传完成后，文件信息显示在输入框中
5. 用户可以继续输入问题

---

### 3. 测试数据库集成

#### 3.1 Chinook 数据库

**下载地址**：
`https://github.com/lerocha/chinook-database`

**文件名**：
`Chinook_Sqlite.sqlite`

**表结构**：
```
├── Artist        艺术家
├── Album         专辑
├── Track         曲目（含时长、单价）
├── MediaType     媒体类型
├── Genre         音乐类型
├── Playlist      播放列表
├── Customer      客户（含国家、城市）
├── Invoice       发票/订单
├── InvoiceItem   订单明细
└── Employee      员工（含上下级关系）
```

**适合测试的查询类型**：
- 销售额统计、趋势分析 → 折线图 / 柱状图
- 各国/地区消费分布 → 饼图 / 地图
- 最畅销艺术家/专辑排名 → 排行榜
- 员工销售业绩对比 → 对比柱状图
- 多表关联（客户+订单+曲目）→ 复杂 SQL 测试

---

#### 3.2 Northwind 数据库

**下载地址**：
`https://github.com/jpwhite3/northwind-SQLite3`

**文件名**：
`northwind.db`

**表结构**：
```
├── Customers      客户
├── Orders         订单
├── OrderDetails   订单明细
├── Products       产品（含库存、单价）
├── Categories     产品分类
├── Suppliers      供应商
├── Employees      员工
├── Shippers       物流商
└── Region/Territory 区域信息
```

**适合测试的查询类型**：
- 按季度/月份的销售趋势
- 各类别产品的销售占比
- 库存预警（库存低于再订货量）
- 员工绩效排名
- 供应商供货量分析

---

## 开发阶段

### Phase 1 - 前端 UI 开发

**任务**：
- [ ] 1.1 添加思考模式切换开关（默认关闭）
- [ ] 1.2 添加加号按钮（支持上传照片和文件）
- [ ] 1.3 设计文件上传 UI 组件

**交付物**：
- 思考模式切换组件
- 文件上传组件
- 文件预览组件

---

### Phase 2 - 后端接口开发

**任务**：
- [ ] 2.1 下载并集成 Chinook 数据库
- [ ] 2.2 下载并集成 Northwind 数据库
- [ ] 2.3 实现思考模式开关接口
- [ ] 2.4 实现文件上传接口

**交付物**：
- 数据库配置管理（支持多数据库切换）
- 思考模式开关 API
- 文件上传 API
- 文件存储服务

---

### Phase 3 - 前后端联调

**任务**：
- [ ] 3.1 测试思考模式切换
- [ ] 3.2 测试文件上传功能
- [ ] 3.3 测试新数据库查询

**交付物**：
- 功能测试报告
- Bug 修复
- 性能优化

---

## 技术要点

### 思考模式实现

**后端**：
- 在 `sql_agent.py` 中根据开关参数决定是否启用思考模式
- 修改 `_chat_completion_stream` 方法，接受 `enable_thinking` 参数

**前端**：
- 在 `useSSE.ts` 中传递思考模式参数
- 在 UI 中添加切换开关
- 保存用户偏好到 localStorage

### 文件上传实现

**后端**：
- 使用 FastAPI 的 `UploadFile` 处理文件上传
- 支持图片和文档格式验证
- 文件存储到 `uploads/` 目录
- 返回文件 URL 供 AI 分析

**前端**：
- 使用 `<input type="file">` 或拖拽上传
- 显示上传进度
- 文件预览（图片显示缩略图，文档显示图标）

### 多数据库支持

**配置**：
```python
DATABASE_CONFIG = {
    "business": {
        "path": "data/business.db",
        "name": "业务数据库"
    },
    "chinook": {
        "path": "data/Chinook_Sqlite.sqlite",
        "name": "Chinook 音乐数据库"
    },
    "northwind": {
        "path": "data/northwind.db",
        "name": "Northwind 商业数据库"
    }
}
```

**切换机制**：
- 在前端添加数据库选择器
- 后端根据选择切换数据库连接
- 重新加载 schema 信息
