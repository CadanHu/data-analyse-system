# 005 - iOS 移动端 App 实现与优化记录

## 1. 任务背景
在 v1.3.0 版本基础上，通过 Capacitor 将 DataPulse 智能数据分析系统扩展至 iOS 移动端，实现在 iPhone 模拟器和真机上的完美运行。

## 2. 已解决的关键问题

### 2.1 网络连接与通信
- **CORS 跨域修复**：iOS WebView 的 Origin 为 `capacitor://localhost`，后端已配置允许该来源。
- **本地服务访问**：通过将后端地址硬编码为 `127.0.0.1`（模拟器）或 `bopomofo.local`（局域网发现），解决了 iOS 模拟器无法连接本地宿主机的问题。
- **HTTPS 限制解除**：修改 iOS `Info.plist`，开启 `NSAllowsArbitraryLoads` 允许 HTTP 通信。
- **OPTIONS 预检优化**：后端中间件直接放行 `OPTIONS` 请求，消除了 iOS 发起请求前 60s 的 Pending 延迟。

### 2.2 UI/UX 深度优化
- **Safe Area (刘海屏) 适配**：全局应用 `viewport-fit=cover` 及 `env(safe-area-inset-top)`，确保顶栏不被遮挡。
- **全局导航优化**：
    - 移除了子组件内部的回退按钮。
    - 在屏幕最左上角（时间旁边）实现了全局绝对定位的回退箭头，可一键返回初始欢迎页。
- **点击效率提升**：
    - 禁用了移动端的 CSS Hover 逻辑，解决了切换会话需要点击两次的 Bug。
    - 优化 `setActiveTab` 逻辑，实现点击后的即时视觉反馈。
- **默认入口调整**：进入应用后默认展示“会话列表”，符合移动端使用习惯。

### 2.3 横屏与全屏功能
- **全屏分析模式**：为图表增加了最高层级的全屏覆盖模式，并配备超大关闭按钮。
- **横屏自适应布局**：
    - 横屏下自动缩小顶栏高度。
    - 自动折叠 SQL 预览区为可展开按钮。
    - 启用 `ResizableSplit`，支持横屏下左右拖拽调整侧边栏宽度。
- **滚动修复**：解决了横屏下内容溢出无法上下滚动查看的问题。

### 2.4 调试能力
- **原生调试开启**：在 `AppDelegate.swift` 中注入代码，强制开启 iOS 16.4+ 的 Safari Web 检查器权限。
- **SVG 兼容性**：修复了 iOS 系统对复杂 SVG 路径（Trash Icon）解析报错的问题。

## 3. 待持续优化
- **真机局域网发现**：目前使用 `.local` 域名，在某些复杂 Wi-Fi 环境下可能仍需手动配置 IP。
- **输入法体验**：模拟器对中文输入法的原生支持仍需手动配置。
