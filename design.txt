# æ™ºèƒ½æ•°æ®åˆ†æç³»ç»Ÿ Â· æ¨¡å—è§„åˆ’æ–‡æ¡£

---

## ä¸€ã€ç³»ç»Ÿæ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ React App                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å·¦ä¾§é¢æ¿    â”‚  â”‚      ä¸­é—´é—®ç­”åŒº       â”‚  â”‚  å³ä¾§å›¾è¡¨åŒº    â”‚  â”‚
â”‚  â”‚ ä¼šè¯ç®¡ç†åˆ—è¡¨ â”‚  â”‚  æ¶ˆæ¯æµ + è¾“å…¥æ¡†      â”‚  â”‚ ECharts æ¸²æŸ“  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP / SSEï¼ˆæµå¼ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FastAPI åç«¯                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¼šè¯ç®¡ç†æ¨¡å— â”‚  â”‚  LangChain Agentâ”‚  â”‚   æ•°æ®åº“æ“ä½œæ¨¡å—   â”‚  â”‚
â”‚  â”‚Session Routerâ”‚  â”‚  Text-to-SQL    â”‚  â”‚   SQLite3 Executor â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           é˜¿é‡Œäº‘ç™¾ç‚¼ Qwen3               â”‚
         â”‚     (é€šè¿‡ OpenAI å…¼å®¹æ¥å£æ¥å…¥)            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€åç«¯æ¨¡å—è§„åˆ’

### ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ main.py                    # FastAPI å…¥å£
â”œâ”€â”€ config.py                  # å…¨å±€é…ç½®ï¼ˆAPI Keyã€DBè·¯å¾„ç­‰ï¼‰
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ session_db.py          # ä¼šè¯å…ƒæ•°æ®å­˜å‚¨ï¼ˆSQLiteï¼‰
â”‚   â””â”€â”€ business_db.py         # ä¸šåŠ¡æ•°æ®åº“è¿æ¥ï¼ˆSQLiteï¼‰
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ session_router.py      # ä¼šè¯ CRUD æ¥å£
â”‚   â”œâ”€â”€ chat_router.py         # é—®ç­”ä¸»æ¥å£ï¼ˆSSEæµå¼ï¼‰
â”‚   â””â”€â”€ schema_router.py       # æ•°æ®åº“è¡¨ç»“æ„æŸ¥è¯¢æ¥å£
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ sql_agent.py           # LangChain Text-to-SQL Agent
â”‚   â”œâ”€â”€ chart_agent.py         # å›¾è¡¨é…ç½®ç”Ÿæˆ Agent
â”‚   â””â”€â”€ memory_manager.py      # ä¸Šä¸‹æ–‡è®°å¿†ç®¡ç†
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ sql_executor.py        # SQL æ‰§è¡Œ + ç»“æœæ ¼å¼åŒ–
â”‚   â”œâ”€â”€ stream_service.py      # SSE æµå¼æ¨é€å°è£…
â”‚   â””â”€â”€ schema_service.py      # Schema æå–ä¸ç¼“å­˜
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ session.py             # ä¼šè¯æ•°æ®æ¨¡å‹ï¼ˆPydanticï¼‰
â”‚   â”œâ”€â”€ message.py             # æ¶ˆæ¯æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ chart.py               # å›¾è¡¨é…ç½®æ¨¡å‹
â””â”€â”€ utils/
    â”œâ”€â”€ prompt_templates.py    # æ‰€æœ‰ Prompt æ¨¡æ¿ç»Ÿä¸€ç®¡ç†
    â””â”€â”€ validators.py          # SQL å®‰å…¨æ ¡éªŒ
```

---

### æ¨¡å— 1ï¼šä¼šè¯ç®¡ç†æ¨¡å—

**èŒè´£**ï¼šç®¡ç†ç”¨æˆ·çš„å¤šä¸ªå¯¹è¯ä¼šè¯ï¼Œæ¯ä¸ªä¼šè¯ç‹¬ç«‹ç»´æŠ¤ä¸Šä¸‹æ–‡ã€‚

```
æ¥å£è®¾è®¡ï¼š

POST   /api/sessions          â†’ åˆ›å»ºæ–°ä¼šè¯ï¼Œè¿”å› session_id
GET    /api/sessions          â†’ è·å–æ‰€æœ‰ä¼šè¯åˆ—è¡¨ï¼ˆå«æ ‡é¢˜ã€æ—¶é—´ï¼‰
GET    /api/sessions/{id}     â†’ è·å–å•ä¸ªä¼šè¯è¯¦æƒ… + å†å²æ¶ˆæ¯
DELETE /api/sessions/{id}     â†’ åˆ é™¤ä¼šè¯
PATCH  /api/sessions/{id}     â†’ é‡å‘½åä¼šè¯æ ‡é¢˜
```

**æ•°æ®è¡¨è®¾è®¡ï¼ˆSQLiteï¼‰**ï¼š

```sql
-- ä¼šè¯è¡¨
CREATE TABLE sessions (
    id          TEXT PRIMARY KEY,    -- UUID
    title       TEXT,                -- ä¼šè¯æ ‡é¢˜ï¼ˆé¦–æ¡æ¶ˆæ¯è‡ªåŠ¨æˆªå–ï¼‰
    created_at  DATETIME,
    updated_at  DATETIME
);

-- æ¶ˆæ¯è¡¨
CREATE TABLE messages (
    id          TEXT PRIMARY KEY,
    session_id  TEXT,                -- å…³è”ä¼šè¯
    role        TEXT,                -- user / assistant
    content     TEXT,                -- æ¶ˆæ¯æ­£æ–‡
    sql         TEXT,                -- æœ¬æ¡æ¶ˆæ¯ç”Ÿæˆçš„ SQLï¼ˆå¯ä¸ºç©ºï¼‰
    chart_cfg   TEXT,                -- ECharts JSON é…ç½®ï¼ˆå¯ä¸ºç©ºï¼‰
    created_at  DATETIME,
    FOREIGN KEY (session_id) REFERENCES sessions(id)
);
```

---

### æ¨¡å— 2ï¼šä¸Šä¸‹æ–‡è®°å¿†æ¨¡å—

**èŒè´£**ï¼šè®© Qwen3 åœ¨å¤šè½®å¯¹è¯ä¸­è®°ä½å‰é¢çš„é—®é¢˜å’Œç»“æœï¼Œæ”¯æŒè¿½é—®ï¼ˆå¦‚"å†æŒ‰æœˆä»½æ‹†åˆ†"ï¼‰ã€‚

**å®ç°æ–¹æ¡ˆ**ï¼šä½¿ç”¨ LangChain çš„ `ConversationBufferWindowMemory`ï¼Œæ¯ä¸ª session_id å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ Memory å®ä¾‹ï¼Œä¿å­˜åœ¨å†…å­˜å­—å…¸ä¸­ï¼›æœåŠ¡é‡å¯æ—¶ä» messages è¡¨é‡å»ºã€‚

```
è®°å¿†ç­–ç•¥ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Memory å¯¹è±¡ï¼ˆæ¯ä¸ª Session ä¸€ä¸ªï¼‰                     â”‚
â”‚                                                      â”‚
â”‚  æœ€è¿‘ N è½®å¯¹è¯ï¼ˆé»˜è®¤ä¿ç•™æœ€è¿‘ 10 è½®ï¼‰                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ User:      æŸ¥è¯¢ä¸Šä¸ªæœˆå„åœ°åŒºçš„é”€å”®é¢              â”‚  â”‚
â”‚  â”‚ Assistant: [SQL] + [ç»“æœæ‘˜è¦] + [å›¾è¡¨å·²ç”Ÿæˆ]    â”‚  â”‚
â”‚  â”‚ User:      å†å¸®æˆ‘æŒ‰äº§å“ç±»å‹ç»†åˆ†                  â”‚  â”‚
â”‚  â”‚ Assistant: [SQL] + [ç»“æœæ‘˜è¦] + [å›¾è¡¨å·²ç”Ÿæˆ]    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                      â”‚
â”‚  è¶…å‡º 10 è½®åï¼Œè‡ªåŠ¨è£å‰ªæœ€æ—©çš„å¯¹è¯ï¼Œä¿ç•™æœ€æ–°ä¸Šä¸‹æ–‡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ¨¡å— 3ï¼šLangChain SQL Agent

**èŒè´£**ï¼šæ ¸å¿ƒæ¨¡å—ï¼Œå°†ç”¨æˆ·è‡ªç„¶è¯­è¨€è½¬æ¢ä¸º SQL å¹¶æ‰§è¡Œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿæœ€é‡è¦çš„éƒ¨åˆ†ã€‚

**å·¥ä½œæµï¼ˆLangChain LCEL é“¾å¼è®¾è®¡ï¼‰**ï¼š

```
ç”¨æˆ·è¾“å…¥
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Schema æ³¨å…¥             â”‚
â”‚  æå–ä¸šåŠ¡æ•°æ®åº“æ‰€æœ‰è¡¨çš„ DDL ä¿¡æ¯  â”‚
â”‚  æ‹¼å…¥ System Prompt              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Qwen3 ç”Ÿæˆ SQL          â”‚
â”‚  æºå¸¦å†å²ä¸Šä¸‹æ–‡ + Schema + é—®é¢˜   â”‚
â”‚  è¾“å‡ºç»“æ„åŒ– JSONï¼š               â”‚
â”‚  { "sql": "...", "intent": "..." }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: SQL å®‰å…¨æ ¡éªŒ            â”‚
â”‚  æ£€æŸ¥æ˜¯å¦åŒ…å« DROP/DELETE/UPDATE  â”‚
â”‚  ç­‰å±é™©æ“ä½œï¼Œåªå…è®¸ SELECT        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ æ ¡éªŒé€šè¿‡
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: æ‰§è¡Œ SQL                â”‚
â”‚  è¿æ¥ SQLite3ï¼Œæ‰§è¡ŒæŸ¥è¯¢           â”‚
â”‚  è¿”å›ç»“æ„åŒ–ç»“æœï¼ˆè¡Œåˆ—æ•°æ®ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: æ‰§è¡Œå¤±è´¥ï¼Ÿè‡ªåŠ¨é‡è¯•       â”‚
â”‚  å°†é”™è¯¯ä¿¡æ¯åé¦ˆç»™ Qwen3           â”‚
â”‚  è®©æ¨¡å‹ä¿®æ­£ SQLï¼Œæœ€å¤šé‡è¯• 2 æ¬¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ æ‰§è¡ŒæˆåŠŸ
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: ç”Ÿæˆå›¾è¡¨é…ç½® + æ–‡å­—æ€»ç»“  â”‚
â”‚  Qwen3 æ ¹æ®æŸ¥è¯¢ç»“æœ              â”‚
â”‚  è¾“å‡º ECharts option JSON        â”‚
â”‚  + è‡ªç„¶è¯­è¨€åˆ†ææ‘˜è¦              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Prompt æ¨¡æ¿è®¾è®¡**ï¼š

```
System Prompt ç»“æ„ï¼š

ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®åˆ†æåŠ©æ‰‹ï¼Œå¯ä»¥å°†ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€è½¬æ¢ä¸º SQL æŸ¥è¯¢ã€‚

ã€æ•°æ®åº“ä¿¡æ¯ã€‘
{schema}        â† åŠ¨æ€æ³¨å…¥æ‰€æœ‰è¡¨çš„ DDL

ã€å¯¹è¯å†å²ã€‘
{history}       â† LangChain Memory è‡ªåŠ¨å¡«å……

ã€è¾“å‡ºè¦æ±‚ã€‘
å¿…é¡»è¿”å›åˆæ³•çš„ JSON æ ¼å¼ï¼š
{
  "sql": "SELECT ...",
  "chart_type": "bar|line|pie|scatter|table",
  "reasoning": "æˆ‘çš„åˆ†ææ€è·¯..."
}
```

---

### æ¨¡å— 4ï¼šå›¾è¡¨é…ç½®ç”Ÿæˆæ¨¡å—

**èŒè´£**ï¼šå°† SQL æŸ¥è¯¢ç»“æœè½¬æ¢ä¸º ECharts å¯ç›´æ¥ä½¿ç”¨çš„ option é…ç½®ã€‚

```
è¾“å…¥ï¼šSQL æŸ¥è¯¢ç»“æœï¼ˆè¡Œåˆ—æ•°æ®ï¼‰+ chart_type æ„å›¾

è¾“å‡ºï¼šæ ‡å‡† ECharts option JSON

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å›¾è¡¨ç±»å‹æ˜ å°„ç­–ç•¥                                     â”‚
â”‚                                                      â”‚
â”‚  ç”¨æˆ·é—®"è¶‹åŠ¿/å˜åŒ–/èµ°åŠ¿"  â†’  æŠ˜çº¿å›¾ (line)            â”‚
â”‚  ç”¨æˆ·é—®"å¯¹æ¯”/æ’å/æœ€å¤š"  â†’  æŸ±çŠ¶å›¾ (bar)             â”‚
â”‚  ç”¨æˆ·é—®"å æ¯”/æ„æˆ/åˆ†å¸ƒ"  â†’  é¥¼å›¾  (pie)              â”‚
â”‚  ç”¨æˆ·é—®"ç›¸å…³æ€§/åˆ†å¸ƒ"     â†’  æ•£ç‚¹å›¾ (scatter)         â”‚
â”‚  ç»“æœåˆ—æ•° > 5 æˆ–æ— æ˜æ˜¾å›¾è¡¨æ„å›¾  â†’  è¡¨æ ¼ (table)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ¨¡å— 5ï¼šSSE æµå¼æ¨é€æ¨¡å—

**èŒè´£**ï¼šå°† Agent æ¯ä¸ªå¤„ç†é˜¶æ®µå®æ—¶æ¨é€åˆ°å‰ç«¯ï¼Œé¿å…ç”¨æˆ·é•¿æ—¶é—´ç­‰å¾…ç™½å±ã€‚

```
æ¨é€äº‹ä»¶æ ¼å¼è®¾è®¡ï¼š

event: thinking
data: {"content": "æ­£åœ¨ç†è§£æ‚¨çš„é—®é¢˜..."}

event: schema_loaded  
data: {"tables": ["orders", "users", "products"]}

event: sql_generated
data: {"sql": "SELECT region, SUM(amount) FROM orders..."}

event: sql_executing
data: {"content": "æ­£åœ¨æŸ¥è¯¢æ•°æ®åº“..."}

event: sql_result
data: {"rows": [...], "columns": [...], "row_count": 128}

event: chart_ready
data: {"option": { ECharts option JSON }, "chart_type": "bar"}

event: summary
data: {"content": "æœ¬æœˆåä¸œåœ°åŒºé”€å”®é¢æœ€é«˜ï¼Œè¾¾åˆ° 320 ä¸‡å…ƒ..."}

event: done
data: {"message_id": "xxx"}
```

---

## ä¸‰ã€å‰ç«¯æ¨¡å—è§„åˆ’

### ç›®å½•ç»“æ„

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ main.tsx
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ sessionApi.ts       # ä¼šè¯å¢åˆ æ”¹æŸ¥è¯·æ±‚
â”‚   â”‚   â””â”€â”€ chatApi.ts          # SSE æµå¼è¯·æ±‚å°è£…
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”œâ”€â”€ sessionStore.ts     # Zustandï¼šä¼šè¯åˆ—è¡¨çŠ¶æ€
â”‚   â”‚   â””â”€â”€ chatStore.ts        # Zustandï¼šæ¶ˆæ¯æµ + å›¾è¡¨çŠ¶æ€
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”‚   â”œâ”€â”€ LeftPanel.tsx   # å·¦ä¾§ä¼šè¯ç®¡ç†é¢æ¿
â”‚   â”‚   â”‚   â”œâ”€â”€ MiddlePanel.tsx # ä¸­é—´é—®ç­”åŒºåŸŸ
â”‚   â”‚   â”‚   â””â”€â”€ RightPanel.tsx  # å³ä¾§å›¾è¡¨å±•ç¤ºåŒº
â”‚   â”‚   â”œâ”€â”€ session/
â”‚   â”‚   â”‚   â”œâ”€â”€ SessionList.tsx      # ä¼šè¯åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ SessionItem.tsx      # å•æ¡ä¼šè¯é¡¹
â”‚   â”‚   â”‚   â””â”€â”€ NewSessionBtn.tsx    # æ–°å»ºä¼šè¯æŒ‰é’®
â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageList.tsx      # æ¶ˆæ¯æµåˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageItem.tsx      # å•æ¡æ¶ˆæ¯ï¼ˆå« SQL ä»£ç å—ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ ThinkingIndicator.tsx # æ€è€ƒä¸­åŠ¨ç”»
â”‚   â”‚   â”‚   â”œâ”€â”€ SqlBlock.tsx         # SQL ä»£ç é«˜äº®å±•ç¤º
â”‚   â”‚   â”‚   â””â”€â”€ InputBar.tsx         # åº•éƒ¨è¾“å…¥æ¡†
â”‚   â”‚   â””â”€â”€ chart/
â”‚   â”‚       â”œâ”€â”€ ChartPanel.tsx       # å›¾è¡¨å®¹å™¨
â”‚   â”‚       â”œâ”€â”€ EChartsRenderer.tsx  # ECharts æ¸²æŸ“æ ¸å¿ƒç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ ChartTypeTabs.tsx    # å›¾è¡¨ç±»å‹åˆ‡æ¢
â”‚   â”‚       â””â”€â”€ DataTable.tsx        # åŸå§‹æ•°æ®è¡¨æ ¼å±•ç¤º
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useSSE.ts           # SSE è¿æ¥ä¸äº‹ä»¶å¤„ç† Hook
â”‚   â”‚   â””â”€â”€ useChart.ts         # å›¾è¡¨çŠ¶æ€ç®¡ç† Hook
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ session.ts
â”‚       â”œâ”€â”€ message.ts
â”‚       â””â”€â”€ chart.ts
```

---

### ä¸‰æ å¸ƒå±€è§„åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¦ä¾§é¢æ¿     â”‚        ä¸­é—´é—®ç­”åŒº              â”‚     å³ä¾§å›¾è¡¨åŒº        â”‚
â”‚  å®½ï¼š260px   â”‚     flex: 1ï¼ˆè‡ªé€‚åº”ï¼‰          â”‚     å®½ï¼š420px        â”‚
â”‚              â”‚                              â”‚                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ + æ–°å¯¹è¯  â”‚ â”‚  â”‚  æ¶ˆæ¯ 1ï¼ˆç”¨æˆ·ï¼‰         â”‚  â”‚  â”‚  å›¾è¡¨æ ‡é¢˜       â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  æ¶ˆæ¯ 2ï¼ˆAI å›å¤ï¼‰       â”‚  â”‚  â”‚  [åˆ‡æ¢: æŸ±/æŠ˜/ â”‚  â”‚
â”‚              â”‚  â”‚   â”œ æ€è€ƒè¿‡ç¨‹æŠ˜å å—       â”‚  â”‚  â”‚   é¥¼/è¡¨æ ¼]     â”‚  â”‚
â”‚  ä»Šå¤©         â”‚  â”‚   â”œ SQL ä»£ç å—          â”‚  â”‚  â”‚                â”‚  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚   â”œ æ•°æ®æ‘˜è¦æ–‡å­—        â”‚  â”‚  â”‚                â”‚  â”‚
â”‚ â”‚ é”€å”®åˆ†æ  â”‚ â”‚  â”‚   â”” å›¾è¡¨å·²ç”Ÿæˆæç¤º      â”‚  â”‚  â”‚  ECharts å›¾è¡¨  â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  æ¶ˆæ¯ 3ï¼ˆç”¨æˆ·è¿½é—®ï¼‰      â”‚  â”‚  â”‚    æ¸²æŸ“åŒºåŸŸ     â”‚  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  æ¶ˆæ¯ 4ï¼ˆAI å›å¤ï¼‰       â”‚  â”‚  â”‚                â”‚  â”‚
â”‚ â”‚ ç”¨æˆ·ç”»åƒ  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                              â”‚                      â”‚
â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  æ˜¨å¤©         â”‚  â”‚  ğŸ¤” æ­£åœ¨ç”Ÿæˆ SQL...     â”‚  â”‚  â”‚  åŸå§‹æ•°æ®è¡¨æ ¼   â”‚  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ æµå¼è¾“å‡º    â”‚  â”‚  â”‚  å¯æŠ˜å /å±•å¼€   â”‚  â”‚
â”‚ â”‚ åº“å­˜è¶‹åŠ¿  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                              â”‚                      â”‚
â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚              â”‚  â”‚ è¾“å…¥æ¡†                  â”‚  â”‚  â”‚  å¯¼å‡ºæŒ‰é’®       â”‚  â”‚
â”‚              â”‚  â”‚ [å‘é€]                  â”‚  â”‚  â”‚ PNG / CSV / SQLâ”‚  â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å‰ç«¯æ ¸å¿ƒäº¤äº’æµç¨‹

```
ç”¨æˆ·åœ¨è¾“å…¥æ¡†å‘é€æ¶ˆæ¯
         â”‚
         â–¼
chatStore æ·»åŠ  user æ¶ˆæ¯åˆ°åˆ—è¡¨
         â”‚
         â–¼
è°ƒç”¨ useSSE Hookï¼Œå»ºç«‹ SSE è¿æ¥
         â”‚
         â–¼
ç›‘å¬å„ç±» SSE äº‹ä»¶ï¼Œå®æ—¶æ›´æ–° UIï¼š

  event: thinking      â†’ ä¸­é—´åŒºæ˜¾ç¤º"æ€è€ƒä¸­"åŠ¨ç”»
  event: sql_generated â†’ ä¸­é—´åŒºæ¸²æŸ“ SQL ä»£ç å—
  event: sql_result    â†’ å³ä¾§å›¾è¡¨åŒºå‡†å¤‡æ•°æ®
  event: chart_ready   â†’ å³ä¾§ EChartsRenderer æ¥æ”¶ optionï¼Œæ¸²æŸ“å›¾è¡¨
  event: summary       â†’ ä¸­é—´åŒºæµå¼è¾“å‡ºæ–‡å­—æ€»ç»“
  event: done          â†’ å…³é—­ SSEï¼Œä¿å­˜å®Œæ•´æ¶ˆæ¯åˆ° store
```

---

## å››ã€å…³é”®æ¥å£æ€»è§ˆ

```
åç«¯ API æ±‡æ€»ï¼š

ä¼šè¯ç®¡ç†ï¼š
  POST   /api/sessions                  åˆ›å»ºä¼šè¯
  GET    /api/sessions                  ä¼šè¯åˆ—è¡¨
  GET    /api/sessions/{id}/messages    ä¼šè¯å†å²æ¶ˆæ¯
  DELETE /api/sessions/{id}             åˆ é™¤ä¼šè¯
  PATCH  /api/sessions/{id}             é‡å‘½å

æ ¸å¿ƒé—®ç­”ï¼š
  POST   /api/chat/stream               å‘é€æ¶ˆæ¯ï¼ˆSSE æµå¼è¿”å›ï¼‰
  Body:  { session_id, question }

æ•°æ®åº“å…ƒä¿¡æ¯ï¼š
  GET    /api/schema                    è·å–æ‰€æœ‰è¡¨ç»“æ„ï¼ˆä¾›å‰ç«¯å±•ç¤ºï¼‰
```

---

## äº”ã€å¼€å‘é˜¶æ®µå»ºè®®

```
é˜¶æ®µ 1ï¼ˆ1-2å¤©ï¼‰ï¼šç¯å¢ƒæ­å»º
  â”œâ”€â”€ FastAPI é¡¹ç›®åˆå§‹åŒ– + æ¥å…¥é˜¿é‡Œäº‘ç™¾ç‚¼ Qwen3
  â”œâ”€â”€ SQLite ä¸šåŠ¡æ•°æ®åº“å‡†å¤‡ï¼ˆå»ºè¡¨ + å½•å…¥æµ‹è¯•æ•°æ®ï¼‰
  â””â”€â”€ React é¡¹ç›®åˆå§‹åŒ– + ä¸‰æ å¸ƒå±€éª¨æ¶

é˜¶æ®µ 2ï¼ˆ2-3å¤©ï¼‰ï¼šæ ¸å¿ƒé“¾è·¯è·‘é€š
  â”œâ”€â”€ åç«¯ï¼šLangChain SQL Agent å®ç°ï¼ˆSchemaæ³¨å…¥ â†’ SQLç”Ÿæˆ â†’ æ‰§è¡Œï¼‰
  â”œâ”€â”€ åç«¯ï¼šSSE æµå¼æ¨é€æ¥å£å®ç°
  â””â”€â”€ å‰ç«¯ï¼šuseSSE Hook + æ¶ˆæ¯æµæ¸²æŸ“

é˜¶æ®µ 3ï¼ˆ2å¤©ï¼‰ï¼šä¼šè¯ä¸è®°å¿†
  â”œâ”€â”€ ä¼šè¯ CRUD æ¥å£ + å‰ç«¯å·¦ä¾§é¢æ¿
  â””â”€â”€ ConversationBufferWindowMemory æ¥å…¥ï¼ŒéªŒè¯å¤šè½®è¿½é—®

é˜¶æ®µ 4ï¼ˆ2å¤©ï¼‰ï¼šå›¾è¡¨æ¸²æŸ“
  â”œâ”€â”€ ECharts é›†æˆ + å›¾è¡¨ç±»å‹è‡ªåŠ¨é€‰æ‹©
  â”œâ”€â”€ å‰ç«¯å³ä¾§å›¾è¡¨é¢æ¿å®ç°
  â””â”€â”€ æ•°æ®è¡¨æ ¼ + å¯¼å‡ºåŠŸèƒ½

é˜¶æ®µ 5ï¼ˆ1-2å¤©ï¼‰ï¼šç¨³å®šæ€§ä¸ä½“éªŒ
  â”œâ”€â”€ SQL å®‰å…¨æ ¡éªŒ + é”™è¯¯é‡è¯•æœºåˆ¶
  â”œâ”€â”€ åŠ è½½çŠ¶æ€ã€ç©ºçŠ¶æ€ã€é”™è¯¯çŠ¶æ€ UI
  â””â”€â”€ è”è°ƒæµ‹è¯•
```

---